#!/usr/bin/env bash
set -euo pipefail

# Check if nextflow is installed
if ! command -v nextflow &> /dev/null; then
    echo "Error: nextflow is not installed or not in PATH"
    echo "Please install nextflow from https://www.nextflow.io/"
    exit 1
fi

# Separate nextflow lint flags from file arguments.
# pre-commit passes: [args...] [filenames...]
# Flags that take a value: -output/-o, -exclude, -spaces
args=()
files=()
expect_value=false
for arg in "$@"; do
    if $expect_value; then
        args+=("$arg")
        expect_value=false
    elif [[ "$arg" == -* && ${#files[@]} -eq 0 ]]; then
        args+=("$arg")
        # These flags require a following value argument
        case "$arg" in
            -output|-o|-exclude|-spaces) expect_value=true ;;
        esac
    else
        files+=("$arg")
    fi
done

# If no files were passed, nothing to lint
if [[ ${#files[@]} -eq 0 ]]; then
    echo "No Nextflow files found to lint"
    exit 0
fi

# Run nextflow lint in batches to avoid "Argument list too long" (E2BIG)
# when pre-commit passes thousands of files on large repos
batch_size=200
lint_failed=false

for ((i=0; i<${#files[@]}; i+=batch_size)); do
    batch=("${files[@]:i:batch_size}")
    # Use ${args[@]+...} for bash 3.x compatibility (empty array + set -u)
    if ! nextflow lint ${args[@]+"${args[@]}"} "${batch[@]}"; then
        lint_failed=true
    fi
done

if $lint_failed; then
    echo "❌ Nextflow lint failed"
    exit 1
else
    echo "✅ Nextflow lint passed"
fi