name: Test Nextflow Lint Pre-commit Hook

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  test:
    name: Test Hook
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        nextflow-version: ["25.04.6", "latest"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nextflow
        uses: nf-core/setup-nextflow@v2
        with:
          version: ${{ matrix.nextflow-version }}

      - name: Make hook executable
        run: chmod +x nextflow-lint-hook

      - name: Test with no files
        run: |
          # Should exit cleanly when no files are passed
          ./nextflow-lint-hook

      - name: Test with valid Nextflow file
        run: |
          cat > test.nf << 'EOF'
          #!/usr/bin/env nextflow
          nextflow.enable.dsl = 2

          process test {
              output: stdout
              script: "echo 'test'"
          }

          workflow { test() }
          EOF

          ./nextflow-lint-hook test.nf

      - name: Test with valid config file
        run: |
          cat > nextflow.config << 'EOF'
          params {
              input = 'test'
              output = 'results'
          }
          EOF

          ./nextflow-lint-hook nextflow.config

      - name: Test with multiple files
        run: |
          ./nextflow-lint-hook test.nf nextflow.config

      - name: Test with arguments
        run: |
          ./nextflow-lint-hook -output concise test.nf
          ./nextflow-lint-hook -format test.nf nextflow.config

      - name: Test invalid file fails
        run: |
          cat > invalid.nf << 'EOF'
          #!/usr/bin/env nextflow
          process bad { script: "echo test"
          EOF

          # Should fail with invalid syntax
          if ./nextflow-lint-hook invalid.nf; then
            echo "Should have failed"
            exit 1
          fi

      - name: Test mixed valid and invalid files
        run: |
          # One bad file should fail the entire batch
          if ./nextflow-lint-hook test.nf invalid.nf; then
            echo "Should have failed with mixed valid/invalid files"
            exit 1
          fi

      - name: Test config-only with args
        run: |
          ./nextflow-lint-hook -output concise nextflow.config

      - name: Test -format modifies files
        run: |
          cat > unformatted.nf << 'EOF'
          process UNFORMATTED {
          output:
          stdout
          script:
          "echo test"
          }
          EOF

          cp unformatted.nf unformatted.nf.bak
          ./nextflow-lint-hook -format unformatted.nf
          # File should have been modified by -format
          if diff -q unformatted.nf unformatted.nf.bak > /dev/null 2>&1; then
            echo "Warning: -format did not modify the file (may be already formatted)"
          else
            echo "-format correctly modified the file"
          fi

      - name: Test file with spaces in path
        run: |
          mkdir -p "test dir"
          cp test.nf "test dir/my workflow.nf"
          ./nextflow-lint-hook "test dir/my workflow.nf"
          rm -rf "test dir"

  test-pre-commit:
    name: Test Pre-commit Integration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install pre-commit
          curl -s https://get.nextflow.io | bash
          sudo mv nextflow /usr/local/bin/

      - name: Make hook executable
        run: chmod +x nextflow-lint-hook

      - name: Test pre-commit integration
        run: |
          cat > .pre-commit-config.yaml << 'EOF'
          repos:
            - repo: local
              hooks:
                - id: nextflow-lint
                  name: Nextflow Lint
                  entry: ./nextflow-lint-hook
                  language: script
                  files: \.(nf|config)$
                  pass_filenames: true
          EOF

          cat > main.nf << 'EOF'
          #!/usr/bin/env nextflow
          nextflow.enable.dsl = 2

          process test {
              output: stdout
              script: "echo 'test'"
          }

          workflow { test() }
          EOF

          # Create a non-Nextflow file that should be ignored by the hook
          echo "print('hello')" > script.py

          pre-commit run --all-files

          # Verify the .py file didn't trigger the hook (it would fail if passed)
          echo "Pre-commit correctly filtered non-matching files"

  test-no-nextflow:
    name: Test Without Nextflow
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make hook executable
        run: chmod +x nextflow-lint-hook

      - name: Test graceful failure
        run: |
          cat > test.nf << 'EOF'
          #!/usr/bin/env nextflow
          process test { script: "echo test" }
          EOF

          # Should fail gracefully without Nextflow
          if ./nextflow-lint-hook test.nf; then
            echo "Should have failed without Nextflow"
            exit 1
          fi
